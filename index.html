<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     To the MOUNTAIN
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/山.png" />
  
  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/js/pace.min.js"></script>


  

  

<link rel="alternate" href="/atom.xml" title="To the MOUNTAIN" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    <main class="content">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/frontcover.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">To the MOUNTAIN</a></h1>
      <h2>Learn &amp; Life</h2>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>

<div id="main">
  <section class="outer">
  <article class="articles">
    
    
    
    
    <article id="post-任怡凤" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/02/25/%E4%BB%BB%E6%80%A1%E5%87%A4/"
    >任怡凤</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/02/25/%E4%BB%BB%E6%80%A1%E5%87%A4/" class="article-date">
  <time datetime="2021-02-25T06:43:25.118Z" itemprop="datePublished">2021-02-25</time>
</a>
      
      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      
      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/25/%E4%BB%BB%E6%80%A1%E5%87%A4/" data-id="cklkn7p92000028ypfw7caepx"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-【无Anaconda】Jupyterlab更改默认启动路径及创建桌面快捷方式" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/"
    >【win10无Anaconda】JupyterLab更改默认启动路径及创建桌面快捷方式</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/" class="article-date">
  <time datetime="2021-02-24T03:28:38.861Z" itemprop="datePublished">2021-02-24</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="【win10无Anaconda】JupyterLab更改默认启动路径及创建桌面快捷方式"><a href="#【win10无Anaconda】JupyterLab更改默认启动路径及创建桌面快捷方式" class="headerlink" title="【win10无Anaconda】JupyterLab更改默认启动路径及创建桌面快捷方式"></a>【win10无Anaconda】JupyterLab更改默认启动路径及创建桌面快捷方式</h1><p>每一次<strong>JupyterLab</strong>或者<strong>Jupyter Notebook</strong>启动时都需要在命令行下跳至对应目录文件夹，再输入<code>jupyter lab</code>或者<code>jupyter notebook</code>启动是不是很麻烦？今天来记录一下两个小设置，让启动<strong>JupyterLab</strong>直接双击桌面快捷方式图标即可。</p>
<h2 id="1-JupyterLab更改默认启动路径"><a href="#1-JupyterLab更改默认启动路径" class="headerlink" title="1. JupyterLab更改默认启动路径"></a>1. JupyterLab更改默认启动路径</h2><p>已经有很多博客介绍如何更改<strong>Jupyter Notebook</strong>的默认启动路径，但是新一代的<strong>JupyterLab</strong>似乎还没有很多帖子，我这里就来记录一下。其实与<strong>Jupyter Notebook</strong>配置类似，</p>
<p>（1）先在<code>cmd</code>下输入:</p>
<p><code>jupyter lab --generate-config</code></p>
<p>生成默认配置文件。</p>
<p>（2）找到刚刚生成的配置文件，默认存储于<code>C:\Users\你的用户\.jupyter</code>路径下，打开jupyter_lab_config.py`文件。</p>
<p>（3）在412行左右，修改路径文件为你需要的默认启动路径。</p>
<p>注意：使用<strong>/</strong>分隔路径，同时记得<strong>去掉前面的#号</strong>。</p>
<img src="/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/%E4%BF%AE%E6%94%B9%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84.PNG" class title="[修改启动路径]">

<p>（4）保存退出即可。</p>
<h2 id="2-创建-Jupyter-lab桌面快捷方式"><a href="#2-创建-Jupyter-lab桌面快捷方式" class="headerlink" title="2. 创建 Jupyter lab桌面快捷方式"></a>2. 创建 Jupyter lab桌面快捷方式</h2><p>网上我查到的都是讲解如何在<strong>Anaconda</strong>环境下创建<strong>JupyterLab</strong>快捷方式，但是我没有装体积庞大的<strong>Anaconda</strong>。其实很简单，自己编写一个简单的<strong>bat</strong>程序，然后为其创建桌面快捷方式并且自定义图标即可。</p>
<p>（1）创建一个记事本文件，输入：</p>
<p><code>jupyter lab</code></p>
<p>（2）更改记事本文件的后缀名为<code>.bat</code></p>
<p>（3）<code>.bat</code>文件无法直接更改图标，你先将<code>bat</code>程序放到你电脑里一个安全的路径，然后右键发送到桌面快捷方式。</p>
<p>（4）右键刚刚创建的快捷方式，点击<strong>属性</strong>，而后点击<strong>更改图标</strong>，设为你想要的图标即可。</p>
<img src="/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/%E6%9B%B4%E6%94%B9%E5%9B%BE%E6%A0%87.PNG" class title="[更改图标]">

<p>（5）图标文件的后缀为<code>.ico</code>，可以下载常见的<code>.jpg,.png</code>格式图片制作。</p>
<p>可以另存为.bmp文件再直接改后缀为.ico，不过这样图片质量损失较大。建议使用在线的.ico制作网站，上传图片转换即可。</p>
<img src="/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/jupyterlab.png" class title="[jupyterlab_png]">

<p>（6）然后双击桌面的快捷方式，即可启动Jupyter lab啦！</p>
<img src="/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/%E5%9B%BE%E6%A0%87.PNG" class title="[图标]">
      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/24/%E3%80%90%E6%97%A0Anaconda%E3%80%91Jupyterlab%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E5%90%AF%E5%8A%A8%E8%B7%AF%E5%BE%84%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%A1%8C%E9%9D%A2%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/" data-id="ckliwely60000qgypb5t5fvqq"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JupyterLab/" rel="tag">JupyterLab</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-IBM Watson Studio云机器学习平台" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/02/22/IBM%20Watson%20Studio%E4%BA%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/"
    >IBM Watson Studio云机器学习平台</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/02/22/IBM%20Watson%20Studio%E4%BA%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/" class="article-date">
  <time datetime="2021-02-22T14:35:06.654Z" itemprop="datePublished">2021-02-22</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="IBM-Watson-Studio云机器学习平台"><a href="#IBM-Watson-Studio云机器学习平台" class="headerlink" title="IBM Watson Studio云机器学习平台"></a>IBM Watson Studio云机器学习平台</h1><p><a href="https://cloud.ibm.com/catalog/services/watson-studio?cm_mmc=Email_Newsletter-_-Developer_Ed%2BTech-_-WW_WW-_-SkillsNetwork-Courses-IBMDeveloperSkillsNetwork-ML0101EN-SkillsNetwork-20718538-www-coursera-org-www-coursera-org&amp;cm_mmca1=000026UJ&amp;cm_mmca2=10006555&amp;cm_mmca3=M12345678&amp;cvosrc=email.Newsletter.M12345678&amp;cvo_campaign=000026U" target="_blank" rel="noopener">IBM Watson Studio</a>是IBM Cloud云服务中的一个核心平台，集成了很多人工智能工具，可以连接数据库进行云存储，创建Dashboard仪表盘，在线训练你的机器学习模型，支持Jupyter Notebook编写代码及分享，支持RStudio、SPSS Modeler等等。并且，其内置了很多已经构建好的机器学习模型，如自然语言文本分类、图像识别、深度学习模型、最优化决策。看起来就很有吸引力！</p>
<img src="/2021/02/22/IBM%20Watson%20Studio%E4%BA%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/%E6%9C%8D%E5%8A%A1.PNG" class title="[服务]">

<img src="/2021/02/22/IBM%20Watson%20Studio%E4%BA%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/home_page.png" class title="[home_page]">

<p>在此分享Coursera上关于简易上手使用IBM Watson Studio的<a href="https://cf-courses-data.s3.us.cloud-object-storage.appdomain.cloud/IBMDeveloperSkillsNetwork-ML0101EN-SkillsNetwork/labs/FinalModule_Coursera/IBM_Watson_Setup.md.html?origin=www.coursera.org" target="_blank" rel="noopener">教程</a>，开始写你在Watson Studio上的第一段Jupyter Notebook代码吧。</p>
<p>同时分享两则<strong>注意事项</strong>：</p>
<ol>
<li><p>注册账户的时候建议使用<strong>Gmail</strong>，不然很可能会注册失败。</p>
</li>
<li><p>Github同步要在repository里新建<strong>master</strong>分支，不要仅有默认的<strong>main</strong>分支，不然Notebook的同步会报错。</p>
</li>
</ol>
<p>IBM Cloud属实功能强大，日后有机会再进一步研究使用。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/22/IBM%20Watson%20Studio%E4%BA%91%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/" data-id="ckli4trba0000ssyp34i9atap"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IBM-Cloud/" rel="tag">IBM Cloud</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/" rel="tag">Machine Learning</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-动态爬取携程网机票信息" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/01/06/%E5%8A%A8%E6%80%81%E7%88%AC%E5%8F%96%E6%90%BA%E7%A8%8B%E7%BD%91%E6%9C%BA%E7%A5%A8%E4%BF%A1%E6%81%AF/"
    >动态爬取携程网机票信息</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/01/06/%E5%8A%A8%E6%80%81%E7%88%AC%E5%8F%96%E6%90%BA%E7%A8%8B%E7%BD%91%E6%9C%BA%E7%A5%A8%E4%BF%A1%E6%81%AF/" class="article-date">
  <time datetime="2021-01-06T09:05:26.229Z" itemprop="datePublished">2021-01-06</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>最近在做有关交通城际出行领域的课题，需要用到一些关于机票的信息，于是就想到从携程网进行爬取相关数据。</p>
<p>但是呢，携程网它的票务信息查询后是一个动态页面，需要下拉才能返回更多的查询结果。所以这需要在一般的解析静态页面的爬虫方式上，增加一个<strong>浏览器的模拟器</strong>，来模拟<strong>下拉</strong>这一行为。</p>
<p>本次就是用到<strong>selenium</strong>这一个包的<strong>webdriver</strong>来模拟<strong>打开浏览器</strong>和<strong>下拉</strong>这一行为。</p>
<p>话不多说，直接上代码和注释。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> lxml.html</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlightInfo</span><span class="params">(fromcity,tocity,date)</span>:</span></span><br><span class="line">    url=<span class="string">'https://flights.ctrip.com/itinerary/oneway/%s-%s?classType=ALL&amp;ct=1606269725709&amp;date=%s'</span>%(fromcity,tocity,date)<span class="comment">#携程的单程机票查询url</span></span><br><span class="line">    <span class="comment">#parse the html</span></span><br><span class="line">    browser = webdriver.Chrome()</span><br><span class="line">    browser.get(url)</span><br><span class="line">    browser.implicitly_wait(<span class="number">30</span>)<span class="comment">#等一会儿，等信息解析</span></span><br><span class="line">    browser.find_element_by_class_name(<span class="string">'button'</span>).click()<span class="comment">#模拟点击按钮</span></span><br><span class="line">    browser.implicitly_wait(<span class="number">30</span>)<span class="comment">#多注意休息</span></span><br><span class="line">    browser.find_element_by_class_name(<span class="string">'dtime-sort'</span>).click()<span class="comment">#模拟点击按时间排序按钮</span></span><br><span class="line">    browser.implicitly_wait(<span class="number">30</span>)</span><br><span class="line">    browser.find_element_by_class_name(<span class="string">'dtime-sort'</span>).click()<span class="comment">#再模拟一次点击按时间排序按钮，确保出发时间从早到晚排序</span></span><br><span class="line">    browser.implicitly_wait(<span class="number">30</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取页面初始高度</span></span><br><span class="line">    js = <span class="string">"return action=document.body.scrollHeight"</span></span><br><span class="line">    height = browser.execute_script(js)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将滚动条调整至页面底部</span></span><br><span class="line">    browser.execute_script(<span class="string">'window.scrollTo(0, document.body.scrollHeight)'</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># 定义初始时间戳（秒）</span></span><br><span class="line">    t1 = int(time.time())</span><br><span class="line">    <span class="comment"># 定义循环标识，用于终止while循环</span></span><br><span class="line">    status = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># 重试次数</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> status:</span><br><span class="line">        <span class="comment"># 获取当前时间戳（秒）</span></span><br><span class="line">        t2 = int(time.time())</span><br><span class="line">        <span class="comment"># 判断时间初始时间戳和当前时间戳相差是否大于30秒，小于30秒则下拉滚动条</span></span><br><span class="line">        <span class="keyword">if</span> t2 - t1 &lt; <span class="number">30</span>:</span><br><span class="line">            new_height = browser.execute_script(js)</span><br><span class="line">            <span class="keyword">if</span> new_height &gt; height:</span><br><span class="line">                time.sleep(<span class="number">1</span>)</span><br><span class="line">                browser.execute_script(<span class="string">'window.scrollTo(0, document.body.scrollHeight)'</span>)</span><br><span class="line">                <span class="comment"># 重置初始页面高度</span></span><br><span class="line">                height = new_height</span><br><span class="line">                <span class="comment"># 重置初始时间戳，重新计时</span></span><br><span class="line">                t1 = int(time.time())</span><br><span class="line">        <span class="keyword">elif</span> num &lt; <span class="number">3</span>:  <span class="comment"># 当超过30秒页面高度仍然没有更新时，进入重试逻辑，重试3次，每次等待30秒</span></span><br><span class="line">            time.sleep(<span class="number">3</span>)</span><br><span class="line">            num = num + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 超时并超过重试次数，程序结束跳出循环，并认为页面已经加载完毕！</span></span><br><span class="line">            print(<span class="string">"滚动条已经处于页面最下方！"</span>)</span><br><span class="line">            status = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 滚动条调整至页面顶部</span></span><br><span class="line">            browser.execute_script(<span class="string">'window.scrollTo(0, 0)'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#要用到正则表达式</span></span><br><span class="line"> flightnumber=browser.find_elements_by_css_selector(<span class="string">".search_table_header&gt;.inb.logo&gt;div&gt;div&gt;span&gt;span&gt;span"</span>)<span class="comment">#空格设置为点,&gt;层级关系,不可以跃层查询</span></span><br><span class="line">    departtime=browser.find_elements_by_css_selector(<span class="string">".search_box.search_box_tag.search_box_light.Label_Flight&gt;div&gt;div&gt;.inb.right&gt;div.time_box"</span>)<span class="comment">#空格设置为点,&gt;层级关系</span></span><br><span class="line">    departhub = browser.find_elements_by_css_selector(<span class="string">".search_box.search_box_tag.search_box_light.Label_Flight&gt;div&gt;div&gt;.inb.right&gt;div.airport"</span>)  <span class="comment"># 空格设置为点</span></span><br><span class="line">    arrivetime=browser.find_elements_by_css_selector(<span class="string">".search_box.search_box_tag.search_box_light.Label_Flight&gt;div&gt;div&gt;.inb.left&gt;div.time_box"</span>)<span class="comment">#空格设置为点,&gt;层级关系</span></span><br><span class="line">    arrivehub = browser.find_elements_by_css_selector(<span class="string">".search_box.search_box_tag.search_box_light.Label_Flight&gt;div&gt;div&gt;.inb.left&gt;div.airport"</span>)  <span class="comment"># 空格设置为点</span></span><br><span class="line"></span><br><span class="line">    flightnumberlist=[content.text <span class="keyword">for</span> content <span class="keyword">in</span> flightnumber]</span><br><span class="line">    flightnumberlist=list(filter(<span class="keyword">lambda</span> x: x != <span class="string">'共享'</span>, flightnumberlist))<span class="comment">#删除多余元素</span></span><br><span class="line">    departtimelist=[content.text <span class="keyword">for</span> content <span class="keyword">in</span> departtime]</span><br><span class="line">    departhublist=[content.text <span class="keyword">for</span> content <span class="keyword">in</span> departhub]</span><br><span class="line">    arrivetimelist=[content.text <span class="keyword">for</span> content <span class="keyword">in</span> arrivetime]</span><br><span class="line">    arrivehublist=[content.text <span class="keyword">for</span> content <span class="keyword">in</span> arrivehub]</span><br><span class="line">    <span class="keyword">return</span> flightnumberlist,departtimelist,departhublist,arrivetimelist,arrivehublist</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    date=<span class="string">'2020-11-27'</span></span><br><span class="line">    fromcity=<span class="string">'bjs'</span><span class="comment">#查询北京到上海的机票</span></span><br><span class="line">    tocity=<span class="string">'sha'</span><span class="comment">#查询北京到上海的机票</span></span><br><span class="line">    path = <span class="string">'\\'</span></span><br><span class="line">    flightnumberlist,departtimelist,departhublist,arrivetimelist,arrivehublist=getFlightInfo(fromcity, tocity, date)</span><br><span class="line">    print(flightnumberlist)</span><br><span class="line">    flightinfodict=&#123;<span class="string">'flightnumber'</span>:flightnumberlist,<span class="string">'departtime'</span>:departtimelist,<span class="string">'departhub'</span>:departhublist,</span><br><span class="line">                        <span class="string">'arrivetime'</span>:arrivetimelist,<span class="string">'arrivehub'</span>:arrivehublist&#125;</span><br><span class="line">    flightinfodf=pd.DataFrame(flightinfodict)</span><br><span class="line">    flightinfodf.to_csv(path+<span class="string">'%s-%s航空班次信息.csv'</span>%(fromcity,tocity),encoding=<span class="string">'utf_8_sig'</span>,index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>


      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/01/06/%E5%8A%A8%E6%80%81%E7%88%AC%E5%8F%96%E6%90%BA%E7%A8%8B%E7%BD%91%E6%9C%BA%E7%A5%A8%E4%BF%A1%E6%81%AF/" data-id="ckli4trdg000kssypderu4bd4"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/selenium/" rel="tag">selenium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-PLSQL导入excel数据方法" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/27/PLSQL%E5%AF%BC%E5%85%A5excel%E6%95%B0%E6%8D%AE%E6%96%B9%E6%B3%95/"
    >PLSQL导入excel数据方法以及txt编码转换</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/11/27/PLSQL%E5%AF%BC%E5%85%A5excel%E6%95%B0%E6%8D%AE%E6%96%B9%E6%B3%95/" class="article-date">
  <time datetime="2020-11-27T13:02:43.096Z" itemprop="datePublished">2020-11-27</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <ul>
<li><p>把excel另存为用制表符分隔的txt文件，并确保打开编码正确，中文可以正确显示。</p>
</li>
<li><p>然后用<strong>文本导入器</strong>，不选<strong>ODBC导入器</strong>，导入<strong>已经创建好的有对应字段的空表中</strong>。</p>
</li>
<li><p>推荐<strong>Emeditor</strong>打开超大txt文件，并且实现编码转换。</p>
</li>
</ul>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/11/27/PLSQL%E5%AF%BC%E5%85%A5excel%E6%95%B0%E6%8D%AE%E6%96%B9%E6%B3%95/" data-id="ckli4trbr0002ssyp6kzchsy7"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oracle/" rel="tag">oracle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-【python+geopy包】地理信息检索" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/04/%E3%80%90python+geopy%E5%8C%85%E3%80%91%E5%9C%B0%E7%90%86%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2/"
    >【python+geopy包】地理信息检索</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/11/04/%E3%80%90python+geopy%E5%8C%85%E3%80%91%E5%9C%B0%E7%90%86%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2/" class="article-date">
  <time datetime="2020-11-04T01:03:12.720Z" itemprop="datePublished">2020-11-04</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>之前有写过一篇用高德开放平台API接口进行POI信息获取的博客。但是有的时候检索会无法精确定位到单个所需的设施点位置，会返回很多周边的点，此时自己筛选就会有些麻烦。<br>这次，来介绍一个我最近发现的一个很好用的地理信息检索的python包-<strong>geopy</strong>。不需要使用requests库、url，两行代码即可快速检索。</p>
<p>Geopy包官方指南：<a href="https://www.osgeo.cn/geopy/" target="_blank" rel="noopener">https://www.osgeo.cn/geopy/</a></p>
<h2 id="地理编码器"><a href="#地理编码器" class="headerlink" title="地理编码器"></a>地理编码器</h2><p>使用<code>geopy.geocoders</code>调用很多在线地图API服务（如Google地图、Bing地图、百度地图、OpenStreetMap），可以从字符串解析位置，实现经纬度查询，当然也可以逆检索。本次就以<strong>百度地图</strong>和<strong>OpenStreetMap</strong>为例，介绍使用geopy包，快速检索。</p>
<p><strong>1.百度地图需要提前去其开放平台申请AK</strong></p>
<p>注意申请<strong>服务端</strong>的AK</p>
<img src="/2020/11/04/%E3%80%90python+geopy%E5%8C%85%E3%80%91%E5%9C%B0%E7%90%86%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BEAK.png" class title="[百度地图AK]">

<p><strong>2.开始地理编码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> geopy.geocoders <span class="keyword">import</span> Nominatim,BaiduV3</span><br><span class="line"></span><br><span class="line">geolocator = Nominatim(user_agent=<span class="string">"myapp"</span>)<span class="comment">#基于openStreetMap</span></span><br><span class="line">location = geolocator.geocode(query=<span class="string">"南京站"</span>)</span><br><span class="line">print(location.raw)</span><br><span class="line">print((location.longitude,location.latitude))<span class="comment">#WGS84坐标系</span></span><br><span class="line">print(location.address)</span><br><span class="line"></span><br><span class="line">geolocator = BaiduV3(api_key=<span class="string">'输入你申请的ak'</span>)<span class="comment">#基于百度API构造实例</span></span><br><span class="line">location = geolocator.geocode(query=<span class="string">"南京站"</span>)<span class="comment">#检索字符串</span></span><br><span class="line">print(location.raw)<span class="comment">#返回原始信息</span></span><br><span class="line">print((location.longitude,location.latitude))<span class="comment">#输出百度坐标系下经纬度坐标</span></span><br><span class="line">print(location.address)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OpenStreetMap结果：</span><br><span class="line">&#123;&#39;place_id&#39;: 304447935, &#39;licence&#39;: &#39;Data © OpenStreetMap contributors, ODbL 1.0. https:&#x2F;&#x2F;osm.org&#x2F;copyright&#39;, &#39;osm_type&#39;: &#39;node&#39;, &#39;osm_id&#39;: 8042210546, &#39;boundingbox&#39;: [&#39;32.0912644&#39;, &#39;32.0913644&#39;, &#39;118.7913084&#39;, &#39;118.7914084&#39;], &#39;lat&#39;: &#39;32.0913144&#39;, &#39;lon&#39;: &#39;118.7913584&#39;, &#39;display_name&#39;: &#39;南京站, 南京站换乘通道, 鼓楼区, 南京市, 盱眙县, 江苏省, 210037, China 中国&#39;, &#39;class&#39;: &#39;railway&#39;, &#39;type&#39;: &#39;stop&#39;, &#39;importance&#39;: 0.11100000000000002&#125;</span><br><span class="line">(118.7913584,32.0913144)</span><br><span class="line">南京站, 南京站换乘通道, 鼓楼区, 南京市, 盱眙县, 江苏省, 210037, China 中国</span><br><span class="line"></span><br><span class="line">百度地图API结果：</span><br><span class="line">&#123;&#39;location&#39;: &#123;&#39;lng&#39;: 118.80371375406085, &#39;lat&#39;: 32.093502120303725&#125;, &#39;precise&#39;: 0, &#39;confidence&#39;: 50, &#39;comprehension&#39;: 0, &#39;level&#39;: &#39;火车站&#39;&#125;</span><br><span class="line">(118.80371375406085,32.093502120303725)</span><br><span class="line">火车站</span><br></pre></td></tr></table></figure>

<h2 id="计算距离"><a href="#计算距离" class="headerlink" title="计算距离"></a>计算距离</h2><p>注意，<code>geopy.distance</code>下的<code>geodestic</code>默认测算的是<strong>WGS-84</strong>坐标系下的大地距离。</p>
<p>刚刚调用百度地图API进行的地理编码检索得到的是百度坐标系下的经纬度，需提前进行转换。</p>
<p>这里还是直接用<strong>OpenStreetMap</strong>下的<strong>WGS-84坐标系</strong>下的经纬度作为示例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> geopy.geocoders <span class="keyword">import</span> Nominatim<span class="comment">#经纬度检索</span></span><br><span class="line"><span class="keyword">from</span> geopy.distance <span class="keyword">import</span> geodesic<span class="comment">#计算距离</span></span><br><span class="line"></span><br><span class="line">geolocator = Nominatim(user_agent=<span class="string">"myapp"</span>)</span><br><span class="line">location1 = geolocator.geocode(query=<span class="string">"南京站"</span>)</span><br><span class="line">location2 = geolocator.geocode(query=<span class="string">"南京禄口国际机场"</span>)</span><br><span class="line">print((location1.longitude,location1.latitude))</span><br><span class="line">print((location2.longitude, location2.latitude))</span><br><span class="line">print(<span class="string">'两地距离%s公里'</span>%geodesic((location1.latitude,location1.longitude), (location2.latitude,location2.longitude)).km)<span class="comment">#可以设置单位为公里、米、英里等</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输出结果：</span><br><span class="line">(118.7913584,32.0913144)</span><br><span class="line">(118.87176715003275,31.7324679)</span><br><span class="line">两地距离40.51108155886417公里</span><br></pre></td></tr></table></figure>


      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/11/04/%E3%80%90python+geopy%E5%8C%85%E3%80%91%E5%9C%B0%E7%90%86%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2/" data-id="ckli4trc80008ssyphan5dzhs"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/geopy/" rel="tag">geopy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9C%B0%E5%9B%BEAPI/" rel="tag">地图API</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-基于多元LSTM模型的短时交通流量预测" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/"
    >基于多元LSTM模型的短时交通流量预测</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/" class="article-date">
  <time datetime="2020-06-15T02:19:56.658Z" itemprop="datePublished">2020-06-15</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>正好这学期选修了一门交通流理论的课程，这里介绍一下我最后的课程论文，如何基于上一篇提到的在PeMS数据库下载到的数据，应用LSTM模型进行短时交通流量预测。</p>
<h2 id="1-数据准备"><a href="#1-数据准备" class="headerlink" title="1. 数据准备"></a>1. 数据准备</h2><p>2019年9月1日至9月28日四周的交通流量数据，数据粒度是5分钟一统计，属性包含流率(veh/ 5 minutes),速度(mph),占有率(%),重车比例(%)。</p>
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA.PNG" class title="[数据展示]">

<h2 id="2-数据描述性统计"><a href="#2-数据描述性统计" class="headerlink" title="2. 数据描述性统计"></a>2. 数据描述性统计</h2><h3 id="1-绘制流率、速度、密度三参数基本图"><a href="#1-绘制流率、速度、密度三参数基本图" class="headerlink" title="(1) 绘制流率、速度、密度三参数基本图"></a>(1) 绘制流率、速度、密度三参数基本图</h3><img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/flow&occ.png" class title="[flow&amp;occ]">
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/speed&occ.png" class title="[speed&amp;occ]">
<h3 id="2-概率密度分布"><a href="#2-概率密度分布" class="headerlink" title="(2) 概率密度分布"></a>(2) 概率密度分布</h3><p>绘制流率、速度的概率密度分布图和累积概率密度分布图。</p>
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E6%B5%81%E9%87%8F%E7%9A%84%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E5%88%86%E5%B8%83.png" class title="[流量的概率密度分布]">
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E9%80%9F%E5%BA%A6%E7%9A%84%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E5%88%86%E5%B8%83.png" class title="[速度的概率密度分布]">
<h3 id="3-时间序列变化"><a href="#3-时间序列变化" class="headerlink" title="(3) 时间序列变化"></a>(3) 时间序列变化</h3><p>观察流量、重车分布、速度、占有率的时序变化。<br>以9月1日一天的数据为例：</p>
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E4%BA%A4%E9%80%9A%E6%B5%81%E4%B8%80%E5%A4%A9.png" class title="[交通流一天]">
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E9%80%9F%E5%BA%A6%E5%8D%A0%E6%9C%89%E7%8E%87%E4%B8%80%E5%A4%A9.png" class title="[速度占有率一天]">
<p>所有四周的流量时间序列变化：</p>
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%B5%81%E9%87%8F.png" class title="[时间序列流量]">

<h2 id="3-LSTM模型构建"><a href="#3-LSTM模型构建" class="headerlink" title="3. LSTM模型构建"></a>3. LSTM模型构建</h2><p>以前三周数据训练，最后一周数据预测。时间步设为12，即前一个小时预测下一个5分钟。<br>话不多说，直接上代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> keras.preprocessing.sequence <span class="keyword">import</span> TimeseriesGenerator</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> LSTM, Dense, Activation</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_absolute_error <span class="keyword">as</span> mae</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error <span class="keyword">as</span> mse</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> r2_score</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将序列转换为监督学习问题</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">series_to_supervised</span><span class="params">(datasetX,datasetY,lag)</span>:</span></span><br><span class="line">    print(<span class="string">'x的属性数量'</span>,datasetX.shape[<span class="number">1</span>])</span><br><span class="line">    data_gen = TimeseriesGenerator(datasetX,datasetY, length=lag,</span><br><span class="line">                                   batch_size=<span class="number">1</span>)  <span class="comment"># length是滑lag,sampling_rate是timesteps,batch_size是y的维度</span></span><br><span class="line">    X_out, Y_out = data_gen[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, len(data_gen)):</span><br><span class="line">        batch = data_gen[j]</span><br><span class="line">        x, y = batch</span><br><span class="line">        X_out = np.concatenate((X_out, x))</span><br><span class="line">        Y_out = np.concatenate((Y_out, y))</span><br><span class="line">    X_out = np.delete(X_out, <span class="number">0</span>, axis=<span class="number">0</span>)</span><br><span class="line">    Y_out = np.delete(Y_out, <span class="number">0</span>)</span><br><span class="line">    print(<span class="string">'X shape'</span>,X_out.shape)</span><br><span class="line">    print(<span class="string">'Y shape'</span>, Y_out.shape)</span><br><span class="line">    <span class="keyword">return</span> X_out,Y_out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载数据集</span></span><br><span class="line">path=<span class="string">'.\'</span></span><br><span class="line"><span class="string">olddf=pd.read_excel(path+'</span>PeMS数据.xlsx<span class="string">',sheet_name='</span>Sheet1<span class="string">')</span></span><br><span class="line"><span class="string">df=olddf.copy(deep=False)</span></span><br><span class="line"><span class="string">df['</span>Flow (Veh/<span class="number">5</span> Minutes)<span class="string">']=df['</span>Flow (Veh/<span class="number">5</span> Minutes)<span class="string">'].map(lambda x:3*x)#转换为veh/h/ln</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#生成lstmX,Y</span></span><br><span class="line"><span class="string">input_attributes=['</span>Flow (Veh/<span class="number">5</span> Minutes)<span class="string">','</span>Occupancy (%)<span class="string">','</span>Speed (mph)<span class="string">','</span>Truck Prop (%)<span class="string">']</span></span><br><span class="line"><span class="string">datasetX=df[input_attributes].values</span></span><br><span class="line"><span class="string">datasetY=df['</span>Flow (Veh/<span class="number">5</span> Minutes)<span class="string">']</span></span><br><span class="line"><span class="string">scalerx = MinMaxScaler(feature_range=(0, 1))</span></span><br><span class="line"><span class="string">scalery = MinMaxScaler(feature_range=(0, 1))</span></span><br><span class="line"><span class="string">X_scaled = scalerx.fit_transform(datasetX)</span></span><br><span class="line"><span class="string">Y_scaled= scalery.fit_transform(np.array(datasetY).reshape(-1, 1))</span></span><br><span class="line"><span class="string">X,Y=series_to_supervised(X_scaled,Y_scaled,12)#12个数据点即1小时</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#划分训练集与测试集</span></span><br><span class="line"><span class="string">X_train,X_test,Y_train,Y_test= train_test_split(X,Y,test_size=0.25,random_state=0)</span></span><br><span class="line"><span class="string">print('</span>X_train shape<span class="string">',X_train.shape)</span></span><br><span class="line"><span class="string">print('</span>X_test shape<span class="string">',X_test.shape)</span></span><br><span class="line"><span class="string">print('</span>Y_train shape<span class="string">',Y_train.shape)</span></span><br><span class="line"><span class="string">print('</span>Y_test shape<span class="string">',Y_test.shape)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#构建模型</span></span><br><span class="line"><span class="string"># input_dim是输入的train_x的最后一个维度，train_x的维度为(n_samples, time_steps, input_dim)</span></span><br><span class="line"><span class="string">model = Sequential()</span></span><br><span class="line"><span class="string">model.add(LSTM(30, input_shape=(X_train.shape[1], X_train.shape[2])))</span></span><br><span class="line"><span class="string">model.add(Dense(1))</span></span><br><span class="line"><span class="string">model.add(Activation('</span>tanh<span class="string">'))</span></span><br><span class="line"><span class="string">model.compile(loss='</span>mse<span class="string">', optimizer='</span>adam<span class="string">')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 拟合神经网络模型</span></span><br><span class="line"><span class="string">history = model.fit(X_train, Y_train, epochs=50, batch_size=64, validation_data=(X_train, Y_train), verbose=2,</span></span><br><span class="line"><span class="string">                    shuffle=False)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 绘制训练loss数据</span></span><br><span class="line"><span class="string">fig1 = plt.figure()</span></span><br><span class="line"><span class="string">ax1 = fig1.add_subplot(111)</span></span><br><span class="line"><span class="string">ax1.plot(history.history['</span>loss<span class="string">'], label='</span>train<span class="string">')</span></span><br><span class="line"><span class="string">ax1.plot(history.history['</span>val_loss<span class="string">'], label='</span>test<span class="string">')</span></span><br><span class="line"><span class="string">ax1.set_ylabel('</span>Loss<span class="string">')</span></span><br><span class="line"><span class="string">ax1.set_xlabel('</span>Epochs<span class="string">')</span></span><br><span class="line"><span class="string">plt.legend()</span></span><br><span class="line"><span class="string">plt.show()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 做出预测</span></span><br><span class="line"><span class="string">yhat = model.predict(X_test)</span></span><br><span class="line"><span class="string">invY_predict=scalery.inverse_transform(np.array(yhat).reshape(-1,1))</span></span><br><span class="line"><span class="string">invY_test=scalery.inverse_transform(np.array(Y_test).reshape(-1,1))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print('</span>lstm结果<span class="string">')</span></span><br><span class="line"><span class="string">print('</span>r_square<span class="string">', r2_score(invY_test,invY_predict))</span></span><br><span class="line"><span class="string">print('</span>mae<span class="string">', mae(invY_test,invY_predict))</span></span><br><span class="line"><span class="string">print('</span>rmse<span class="string">', np.sqrt(mse(invY_test,invY_predict)))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fig2 = plt.figure(figsize=(10,7) , dpi=80)</span></span><br><span class="line"><span class="string">ax2 = fig2.add_subplot(111)</span></span><br><span class="line"><span class="string">ax2.plot(invY_test,color='</span>blue<span class="string">', linestyle='</span>-<span class="string">',label='</span>Ground Truth<span class="string">')</span></span><br><span class="line"><span class="string">ax2.plot(invY_predict,color='</span>red<span class="string">', linestyle='</span>--<span class="string">',label='</span>LSTM Prediciton<span class="string">')</span></span><br><span class="line"><span class="string">ax2.set_ylabel('</span>Flow (veh/h/ln)<span class="string">')</span></span><br><span class="line"><span class="string">ax2.set_xlabel('</span>Date<span class="string">')</span></span><br><span class="line"><span class="string">xlabel=[]</span></span><br><span class="line"><span class="string">for i in range(22,30):</span></span><br><span class="line"><span class="string">    xlabel.append('</span><span class="number">9</span>/%d<span class="string">'%(i))</span></span><br><span class="line"><span class="string">ax2.set_xticks(range(0,2304,288))</span></span><br><span class="line"><span class="string">ax2.set_xticklabels(xlabel,rotation=90)</span></span><br><span class="line"><span class="string">plt.legend()</span></span><br><span class="line"><span class="string">plt.show()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#绘制9/28一天的图</span></span><br><span class="line"><span class="string">fig3 = plt.figure(figsize=(10,7) , dpi=80)</span></span><br><span class="line"><span class="string">ax3 = fig3.add_subplot(111)</span></span><br><span class="line"><span class="string">ax3.plot(invY_test[-288:],color='</span>green<span class="string">', linestyle='</span>-<span class="string">',label='</span>Ground Truth<span class="string">')</span></span><br><span class="line"><span class="string">ax3.plot(invY_predict[-288:],color='</span>purple<span class="string">', linestyle='</span>--<span class="string">',label='</span>LSTM Prediciton<span class="string">')</span></span><br><span class="line"><span class="string">ax3.set_ylabel('</span>Flow (veh/h/ln)<span class="string">')</span></span><br><span class="line"><span class="string">ax3.set_xlabel('</span>Time<span class="string">')</span></span><br><span class="line"><span class="string">xlabel=[]</span></span><br><span class="line"><span class="string">for i in range(0,25):</span></span><br><span class="line"><span class="string">    xlabel.append('</span>%d:<span class="number">00</span><span class="string">'%(i))</span></span><br><span class="line"><span class="string">ax3.set_xticks(range(0,289,12))</span></span><br><span class="line"><span class="string">ax3.set_xticklabels(xlabel,rotation=90)</span></span><br><span class="line"><span class="string">plt.legend()</span></span><br><span class="line"><span class="string">plt.show()</span></span><br></pre></td></tr></table></figure>

<h3 id="结果展示："><a href="#结果展示：" class="headerlink" title="结果展示："></a>结果展示：</h3><p>最后一周所有的预测：</p>
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/%E5%85%A8%E9%83%A8%E9%A2%84%E6%B5%8B.png" class title="[全部预测]">
<p>9月28日结果：</p>
<img src="/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/9.28%E9%A2%84%E6%B5%8B.png" class title="[9.28预测]">
<p>预测的效果还可以，毕竟只设置了单隐层。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/15/%E5%9F%BA%E4%BA%8E%E5%A4%9A%E5%85%83LSTM%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%AD%E6%97%B6%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B/" data-id="ckli4trdp000pssyp90jae12o"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LSTM/" rel="tag">LSTM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%A4%E9%80%9A%E6%B5%81/" rel="tag">交通流</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" rel="tag">神经网络</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-下载PeMS交通流数据指南" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/06/15/%E4%B8%8B%E8%BD%BDPeMS%E4%BA%A4%E9%80%9A%E6%B5%81%E6%95%B0%E6%8D%AE%E6%8C%87%E5%8D%97/"
    >下载PeMS交通流数据指南</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/15/%E4%B8%8B%E8%BD%BDPeMS%E4%BA%A4%E9%80%9A%E6%B5%81%E6%95%B0%E6%8D%AE%E6%8C%87%E5%8D%97/" class="article-date">
  <time datetime="2020-06-15T01:25:29.081Z" itemprop="datePublished">2020-06-15</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>今天给大家推荐一个开放的交通数据库，美国加州交通运输局的PeMS数据库，这里有着长达10年的高速公路检测器数据。包含流率、速度、占有率、重车比例、延误、车辆行驶里程、车辆行驶时间、交通事故等类型数据。很多学者都用这里的数据进行研究。<br>所以这里给大家介绍一下这个数据库下载数据的使用方式。</p>
<h2 id="1-要有可以科学上网的VPN"><a href="#1-要有可以科学上网的VPN" class="headerlink" title="1. 要有可以科学上网的VPN"></a>1. 要有可以科学上网的VPN</h2><p>这个请先自行解决。</p>
<h2 id="2-登录PeMS网站并注册账号"><a href="#2-登录PeMS网站并注册账号" class="headerlink" title="2. 登录PeMS网站并注册账号"></a>2. 登录PeMS网站并注册账号</h2><p>官方网址：<a href="http://pems.dot.ca.gov/" target="_blank" rel="noopener">http://pems.dot.ca.gov/</a><br>首页右侧有<font color="red">apply for an account</font>的链接，注册完毕后回到首页右上角登陆已通过的注册账号。</p>
<img src="/2020/06/15/%E4%B8%8B%E8%BD%BDPeMS%E4%BA%A4%E9%80%9A%E6%B5%81%E6%95%B0%E6%8D%AE%E6%8C%87%E5%8D%97/PeMS%E9%A6%96%E9%A1%B5.PNG" class title="[PeMS首页]">

<h2 id="3-明确要下载的数据类型：线：路段-点：检测器"><a href="#3-明确要下载的数据类型：线：路段-点：检测器" class="headerlink" title="3. 明确要下载的数据类型：线：路段|点：检测器"></a>3. 明确要下载的数据类型：线：路段|点：检测器</h2><p>登录进去后，可以看到上面有一栏<font color="blue">“Overview, Facilities&amp;Devices, Performance, Data Quality, Events”</font>，这里细分又有很多数据，大家可以自行根据需要点进去查看。<br>这里我主要介绍下载集计的交通流量、速度、占有率等交通流宏观参数数据。</p>
<img src="/2020/06/15/%E4%B8%8B%E8%BD%BDPeMS%E4%BA%A4%E9%80%9A%E6%B5%81%E6%95%B0%E6%8D%AE%E6%8C%87%E5%8D%97/PeMS%E7%99%BB%E9%99%86%E5%90%8E%E7%95%8C%E9%9D%A2.PNG" class title="[PeMS登陆后界面]">
<p>如这张图所示，以下载某个检测器数据为例，我这里下载I5高速公路主线上编号#716895的检测器<font color="blue">Aggregates</font>集计数据。<br>然后就会跳转到这个检测器的数据，并且系统也提供了基础的数据图表供你直观观看。</p>
<img src="/2020/06/15/%E4%B8%8B%E8%BD%BDPeMS%E4%BA%A4%E9%80%9A%E6%B5%81%E6%95%B0%E6%8D%AE%E6%8C%87%E5%8D%97/%E6%A3%80%E6%B5%8B%E5%99%A8%E6%95%B0%E6%8D%AE%E7%A4%BA%E4%BE%8B.PNG" class title="[检测器数据示例]">

<h2 id="4-选择数据的属性和精度"><a href="#4-选择数据的属性和精度" class="headerlink" title="4. 选择数据的属性和精度"></a>4. 选择数据的属性和精度</h2><p>Quantity, Second Quantity:要下载的数据类型，如流量、速度、占有率等。<br>Granularity: 数据精度，月、周、日、5分钟的颗粒度。<br>另外，可以选择数据的日期覆盖时段、节假日、车道等。</p>
<p>然后点击需要下载的数据格式，这里一般下载<font color="blue">EXPORT to.XLS</font>，比较便于后续数据分析。</p>
<p>好了，就是这么简单，下一篇我来介绍一下我如何用这里的数据进行交通流量的时间序列建模预测。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/15/%E4%B8%8B%E8%BD%BDPeMS%E4%BA%A4%E9%80%9A%E6%B5%81%E6%95%B0%E6%8D%AE%E6%8C%87%E5%8D%97/" data-id="ckli4trcr000cssypf8zl2b41"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%A4%E9%80%9A%E6%B5%81/" rel="tag">交通流</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-【Windows+Cygwin+Darknet+OpenCV】简易上手实现YOLOv3目标检测" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/"
    >【Windows+Cygwin+Darknet+OpenCV】简易上手实现YOLOv3目标检测</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" class="article-date">
  <time datetime="2020-04-12T12:28:33.311Z" itemprop="datePublished">2020-04-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p><a href="https://pjreddie.com/darknet/yolo/" target="_blank" rel="noopener">YOLO(You only look once)</a>是github上很火的一个目标检测算法。它的官网提供了很方便的用C语言编写的程序<strong>Darknet</strong>。<br>但是官网提供的很方便的编译方法是基于Linux和Mac系统的。我这次来讲讲我是如何在自己windows系统下配置<strong>Darknet</strong>模块的。<br><strong>注：我这次是下了Cygwin来模拟Linux系统，因为不想下体积占据几个G的Visual Studio来进行编译，Cygwin安装包本身只有1.3M大小。<br>如果有Visual Studio，可以参照<a href="https://github.com/AlexeyAB/darknet" target="_blank" rel="noopener">AlexeyAB版本</a>进行配置。</strong></p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/YOLO%E5%AE%98%E7%BD%91.png" class title="[官网图]">

<h2 id="基础配置流程"><a href="#基础配置流程" class="headerlink" title="基础配置流程"></a>基础配置流程</h2><p>配置过程参照官网：<a href="https://pjreddie.com/darknet/yolo/" target="_blank" rel="noopener">https://pjreddie.com/darknet/yolo/</a></p>
<p>(1) 将github上的<a href="https://github.com/pjreddie/darknet" target="_blank" rel="noopener">https://github.com/pjreddie/darknet</a> 整个项目下载到本地电脑。<br>    注：此处建议使用下载.zip压缩包的方式，不是直接用git clone到本地文件夹，不然可能后面会遇到couldn’t open file: data/coco.names的问题。<br>(2) 切换到darknet文件夹，使用make命令编译C语言源文件。<br>此时，Windows系统下在cmd命令行会报错无法使用make命令。因为make是linux系统下编译源文件使用的命令。官网也有注明这些命令只在Linux和Mac系统上测试过，未在windows系统下测试。<br>所以，下载Cygwin软件实现在windows平台模拟linux系统操作命令，而后可以使用make命令编译源码，生成darknet.exe可执行文件。安装配置Cygwin 参照这篇博客以及其下面的问答：<a href="https://blog.csdn.net/chunleixiahe/article/details/55666792" target="_blank" rel="noopener">https://blog.csdn.net/chunleixiahe/article/details/55666792</a></p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E5%9C%A8Cygwin%E7%BC%96%E8%AF%91%E6%88%90%E5%8A%9F.png" class title="[在Cygwin编译成功]">
<p>(3)    下载别人已训练好的yolov3.weights模型权重文件，放于darknet根目录下。<br>官网链接（下载较慢）：<a href="https://pjreddie.com/darknet/yolo/" target="_blank" rel="noopener">https://pjreddie.com/darknet/yolo/</a><br>百度云链接：<a href="https://pan.baidu.com/s/1CVgvP4hQQvDNbKmXhmkxqw" target="_blank" rel="noopener">https://pan.baidu.com/s/1CVgvP4hQQvDNbKmXhmkxqw</a> 提取码：jnhn<br>(4) 使用命令./darknet detect cfg/yolov3.cfg yolov3.weights data/dog.jpg完成测试。因为没有配置OpenCV，图片结果不会直接显示的屏幕上，而是存于默认文件夹的根目录predictions.jpg。<br>但是此时默认的程序不会将置信度显示在图片上，只打印于命令行,图片会存于根目录下<code>predictions.jpg</code>。</p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E5%AE%98%E6%96%B9%E6%B5%8B%E8%AF%95%E5%9B%BE%E7%89%87%E7%BB%93%E6%9E%9C%E4%B8%8D%E5%90%AB%E7%BD%AE%E4%BF%A1%E5%BA%A6.jpg" class title="[官方测试图片结果不含置信度]">
<p>(5) 为实现将预测的置信度显示于检测结果图片上，更改默认darknet文件夹下的<code>src/image.c</code>文件<code>draw_detections</code>函数。<br>参照：<a href="https://blog.csdn.net/qq_34795071/article/details/86665620" target="_blank" rel="noopener">https://blog.csdn.net/qq_34795071/article/details/86665620</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">int i,j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; num; ++i)&#123;</span><br><span class="line">    char labelstr[<span class="number">4096</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    int class = -1;</span><br><span class="line">char possible[<span class="number">10</span>];//存放检测的置信值</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">  sprintf(possible,<span class="string">"%.2f"</span>,dets[i].prob[j]);//置信值截取小数点后两位赋给possible</span><br><span class="line">        <span class="keyword">if</span> (dets[i].prob[j] &gt; thresh)&#123;</span><br><span class="line">            if (class &lt; 0) &#123;</span><br><span class="line">                strcat(labelstr, names[j]);</span><br><span class="line">        strcat(labelstr, possible);//标签中加入置信值</span><br><span class="line">                class = j;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                strcat(labelstr, <span class="string">", "</span>);</span><br><span class="line">                strcat(labelstr, names[j]);</span><br><span class="line">        strcat(labelstr, possible);//标签中加入置信值</span><br><span class="line">            &#125;</span><br><span class="line">            printf(<span class="string">"%s: %.0f%%\n"</span>, names[j], dets[i].prob[j]*<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>(6) 删除掉原编译好的darknet.exe, libdarknet.a, libdarknet.so,重新使用make编译源文件，再执行上述检测语句，即可存储含有置信度的图片。</p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/dog_predictions.jpg" class title="[dog_predictions]">
<p>(7) 若想更改检测的默认置信度，在检测命令后添加 -thresh &lt;数值&gt;。<br><code>./darknet detect cfg/yolov3.cfg yolov3.weights data/dog.jpg -thresh 0.4</code></p>
<p><strong>至此已经完成了最基础的Darknet配置来实现YOLOv3算法。</strong></p>
<h2 id="OpenCV拓展实现实时目标检测"><a href="#OpenCV拓展实现实时目标检测" class="headerlink" title="OpenCV拓展实现实时目标检测"></a>OpenCV拓展实现实时目标检测</h2><p>(1)    安装<code>OpenCV</code>，拓展可支持的图片类型，并且将结果自动弹窗显示：<br><code>OpenCV(Windows版本的即可)</code>安装完毕后，需要再次使用<code>Cygwin</code>下载<code>Linux</code>支持的<code>OpenCV</code>相应文件，并将<code>darknet</code>根目录下<code>Makefile</code>用文本打开，开头部分设为OPENCV=1,才可成功编译可支持<code>OpenCV</code>的<code>darknet.exe</code>。<br>编译完基于<code>OpenCV</code>的可执行程序后，不能如原来一样在命令行直接输入检测语句，不然会出现无法展示的报错，配置并启动<code>Xterm</code>才可以解决。</p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/opencv%E9%85%8D%E7%BD%AE%E5%90%8E%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%B9%E6%A1%86%E6%8A%A5%E9%94%99.png" class title="[opencv配置后在命令行弹框报错]">
<p>在<code>Cygwin</code>输入<code>export DISPLAY=:0.0</code>和<code>startxwin &</code>即可启动<code>Xterm</code>，然后输入相应命令，即可出现弹框，如下所示。</p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E5%9C%A8Xterm%E6%88%90%E5%8A%9F%E6%98%BE%E7%A4%BA%E8%87%B3%E7%AA%97%E5%8F%A3%E5%B1%8F%E5%B9%95.png" class title="[在Xterm成功显示至窗口屏幕]">
<p><strong>Xterm使用两则小贴士：</strong>（1）鼠标中键实现“粘贴”；（2）ctrl+右键可以改字号。<br>(2) 参照这篇博客<a href="https://blog.csdn.net/weixin_43590290/article/details/100736307?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2&utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2
">【python+OpenCV+YOLOv3打开笔记本摄像头模型检测】</a>的代码，使用python程序，通过OpenCV调用摄像头实现实时检测。<br>这篇文章调用的是电脑自带摄像头，我通过给安卓手机下载<strong>IP Webcam</strong>软件，实现调用手机摄像头的实时目标检测。<br>具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">video_demo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 加载已经训练好的模型路径，可以是绝对路径或者相对路径</span></span><br><span class="line">    weightsPath = <span class="string">"../yolov3.weights"</span></span><br><span class="line">    configPath = <span class="string">"../cfg/yolov3.cfg"</span></span><br><span class="line">    labelsPath = <span class="string">"../data/coco.names"</span></span><br><span class="line">    <span class="comment"># 初始化一些参数</span></span><br><span class="line">    LABELS = open(labelsPath).read().strip().split(<span class="string">"\n"</span>)  <span class="comment"># 物体类别</span></span><br><span class="line">    COLORS = np.random.randint(<span class="number">0</span>, <span class="number">255</span>, size=(len(LABELS), <span class="number">3</span>), dtype=<span class="string">"uint8"</span>)  <span class="comment"># 颜色</span></span><br><span class="line">    boxes = []</span><br><span class="line">    confidences = []</span><br><span class="line">    classIDs = []</span><br><span class="line">    net = cv2.dnn.readNetFromDarknet(configPath, weightsPath)</span><br><span class="line">    <span class="comment"># 读入待检测的图像</span></span><br><span class="line">    <span class="comment"># 0是代表摄像头编号，只有一个的话默认为0</span></span><br><span class="line"></span><br><span class="line">    url = <span class="string">'http://192.168.0.103:8080/video'</span><span class="comment">##手机ip cam地址</span></span><br><span class="line">    <span class="comment"># url='D:\darknet-master\\airplane.avi'#本地视频</span></span><br><span class="line">    capture = cv2.VideoCapture(url)</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">        ref, image = capture.read()</span><br><span class="line">        (H, W) = image.shape[:<span class="number">2</span>]</span><br><span class="line">        <span class="comment"># 得到 YOLO需要的输出层</span></span><br><span class="line">        ln = net.getLayerNames()</span><br><span class="line">        ln = [ln[i[<span class="number">0</span>] - <span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> net.getUnconnectedOutLayers()]</span><br><span class="line">        <span class="comment"># 从输入图像构造一个blob，然后通过加载的模型，给我们提供边界框和相关概率</span></span><br><span class="line">        blob = cv2.dnn.blobFromImage(image, <span class="number">1</span> / <span class="number">255.0</span>, (<span class="number">416</span>, <span class="number">416</span>), swapRB=<span class="literal">True</span>, crop=<span class="literal">False</span>)</span><br><span class="line">        net.setInput(blob)</span><br><span class="line">        layerOutputs = net.forward(ln)</span><br><span class="line">        <span class="comment"># 在每层输出上循环</span></span><br><span class="line">        <span class="keyword">for</span> output <span class="keyword">in</span> layerOutputs:</span><br><span class="line">            <span class="comment"># 对每个检测进行循环</span></span><br><span class="line">            <span class="keyword">for</span> detection <span class="keyword">in</span> output:</span><br><span class="line">                scores = detection[<span class="number">5</span>:]</span><br><span class="line">                classID = np.argmax(scores)</span><br><span class="line">                confidence = scores[classID]</span><br><span class="line">                <span class="comment"># 过滤掉那些置信度较小的检测结果</span></span><br><span class="line">                <span class="keyword">if</span> confidence &gt; <span class="number">0.5</span>:</span><br><span class="line">                    <span class="comment"># 框后接框的宽度和高度</span></span><br><span class="line">                    box = detection[<span class="number">0</span>:<span class="number">4</span>] * np.array([W, H, W, H])</span><br><span class="line">                    (centerX, centerY, width, height) = box.astype(<span class="string">"int"</span>)</span><br><span class="line">                    <span class="comment"># 边框的左上角</span></span><br><span class="line">                    x = int(centerX - (width / <span class="number">2</span>))</span><br><span class="line">                    y = int(centerY - (height / <span class="number">2</span>))</span><br><span class="line">                    <span class="comment"># 更新检测出来的框</span></span><br><span class="line">                    boxes.append([x, y, int(width), int(height)])</span><br><span class="line">                    confidences.append(float(confidence))</span><br><span class="line">                    classIDs.append(classID)</span><br><span class="line">        <span class="comment"># 极大值抑制</span></span><br><span class="line">        idxs = cv2.dnn.NMSBoxes(boxes, confidences, <span class="number">0.2</span>, <span class="number">0.3</span>)</span><br><span class="line">        <span class="keyword">if</span> len(idxs) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> idxs.flatten():</span><br><span class="line">                (x, y) = (boxes[i][<span class="number">0</span>], boxes[i][<span class="number">1</span>])</span><br><span class="line">                (w, h) = (boxes[i][<span class="number">2</span>], boxes[i][<span class="number">3</span>])</span><br><span class="line">                <span class="comment"># 在原图上绘制边框和类别</span></span><br><span class="line">                color = [int(c) <span class="keyword">for</span> c <span class="keyword">in</span> COLORS[classIDs[i]]]</span><br><span class="line">                cv2.rectangle(image, (x, y), (x + w, y + h), color, <span class="number">2</span>)</span><br><span class="line">                text = <span class="string">"&#123;&#125;: &#123;:.4f&#125;"</span>.format(LABELS[classIDs[i]], confidences[i])</span><br><span class="line">                cv2.putText(image, text, (x, y - <span class="number">5</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.5</span>, color, <span class="number">2</span>)</span><br><span class="line">        cv2.imshow(<span class="string">"Video"</span>, image)</span><br><span class="line">        <span class="comment"># 等待1ms显示图像</span></span><br><span class="line">        c = cv2.waitKey(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> c &amp; <span class="number">0xFF</span> == ord(<span class="string">'q'</span>):  <span class="comment"># 键盘输入英文字母q键退出视频</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">cv2.destroyAllWindows()  <span class="comment"># 销毁所有窗口</span></span><br><span class="line">video_demo()</span><br></pre></td></tr></table></figure>

<p>下面放一下我实时检测的画面：</p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E6%8E%A5%E5%85%A5%E6%89%8B%E6%9C%BA%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E6%A3%80%E6%B5%8B.jpg" class title="[接入手机摄像头实时检测]">
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E7%94%B5%E8%84%91%E5%AE%9E%E6%97%B6%E6%A3%80%E6%B5%8B%E7%A4%BA%E6%84%8F%E7%94%BB%E9%9D%A2.jpg" class title="[电脑实时检测示意画面]">

<h2 id="配置Darknet走过的一些弯路"><a href="#配置Darknet走过的一些弯路" class="headerlink" title="配置Darknet走过的一些弯路"></a>配置Darknet走过的一些弯路</h2><p>(1)    下载CUDA实现GPU运算：<br>需要自己的显卡比较好，同时配置CUDA、CUDNN均需匹配版本号正确，这两个软件体积也特别大。配置这个很麻烦，Darknet官网也说明了这个安装很麻烦，所以不是长久专门使用，不必配置了。<br>但是没有GPU真的处理视频很卡。。。<br>(2)    一开始的make编译Makefile失败，尝试使用windows系统下的Visual Studio中的nmake等方式失败，尝试用MinGW也失败，最终使用Cygwin模拟linux成功。<br>(3) 基于已有的程序，安装完OpenCV后在模拟Linux系统下的视频流的目标侦测目前还是遇到一些问题，无法正常按帧检测，并实时在屏幕上显示检测结果。花费了2天时间进行尝试，还是没有解决这个bug，暂时放弃。有解决的朋友可以告诉我一下。<br>报错：<br><code>(darknet:3866):GLib-GObject-CRITICAL **: g_object_set: assertion 'G_IS_OBJECT (object)' failed</code></p>
<img src="/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E8%A7%86%E9%A2%91%E6%8A%A5%E9%94%99.png" class title="[视频报错]">
<p>所以才最后转投了python程序去调用OpenCV做视频检测，如果你只想做图片检测，按照我上面的做法没问题。<br>(4) 所以当我看到最后的别人的博客调用python程序，去查<code>src</code>的源码实现<code>YOLOv3</code>，不需要配置keras和tensorflow，其实以后自己也可以这样做。自己当初放弃<a href="https://github.com/AlexeyAB/darknet" target="_blank" rel="noopener">AlexeyAB版本</a>的python接口是因为它还是需要导入windows编译过后的<code>dll</code>模块，所以放弃。不过，有兴趣的朋友还是可以一试。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/12/%E3%80%90Windows+Cygwin+Darknet+OpenCV%E3%80%91%E7%AE%80%E6%98%93%E4%B8%8A%E6%89%8B%E5%AE%9E%E7%8E%B0YOLOv3%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" data-id="ckli4trc30006ssypb6spe81r"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenCV/" rel="tag">OpenCV</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/YOLO/" rel="tag">YOLO</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/" rel="tag">图像识别</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-【自然语言处理】Wordcloud词云分析+LDA主题分类" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/"
    >【自然语言处理】Wordcloud词云分析+LDA主题分类</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/" class="article-date">
  <time datetime="2020-04-02T08:33:57.535Z" itemprop="datePublished">2020-04-02</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%BC%96%E7%A8%8B/">软件和编程</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>最近在一门课上，老师分享了一篇关于应用自然语言处理（NLP）模型分析交通领域研究主题分类的论文，我觉得写得很好很有意思。所以，自己也进行一下尝试。<br>主要分为<strong>Wordcloud词云展示</strong>和<strong>Latent Dirichlet Allocation（LDA）模型主题分类</strong>两部分。</p>
<p>参考文献：<a href="https://www.sciencedirect.com/science/article/pii/S0968090X17300207" target="_blank" rel="noopener">Sun, L., &amp; Yin, Y. (2017). Discovering themes and trends in transportation research using topic modeling. Transportation Research Part C: Emerging Technologies, 77, 49-66. doi:10.1016/j.trc.2017.01.013</a></p>
<p>本次分析的是2017年至2020年发表的交通领域关于<strong>“Mobility-as-a-Service(MaaS)”</strong>的30篇论文的摘要部分。</p>
<img src="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/%E6%96%87%E7%8C%AE%E6%A6%82%E8%A7%88.PNG" class title="[文献展示]">

<h2 id="wordcloud词云展示"><a href="#wordcloud词云展示" class="headerlink" title="wordcloud词云展示"></a>wordcloud词云展示</h2><ol>
<li><p>首先对文本进行预处理：</p>
<ul>
<li><p>去除标点符号，按空格拆分句子<br><code>mytext=re.sub(r'[.,()]','',mytext).split(' ') #正侧表达式去除标点</code></p>
</li>
<li><p>用NLTK的wordnet模块进行词形还原</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk.stem <span class="keyword">import</span> WordNetLemmatizer</span><br><span class="line">wnl = WordNetLemmatizer()</span><br><span class="line">remytext = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(mytext)):</span><br><span class="line">    mytext[i]=wnl.lemmatize(mytext[i]) <span class="comment">#词性还原</span></span><br><span class="line">    remytext=remytext+<span class="string">' '</span>+mytext[i]</span><br><span class="line">mytext=remytext</span><br></pre></td></tr></table></figure>

<p><strong>注：wordnet包需要另外独自安装，不然会报如下错误：</strong><br><code>Resource wordnet not found. Please use the NLTK Downloader to obtain the resource:</code></p>
<img src="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/wordnet%E7%BC%BA%E5%A4%B1%E6%8A%A5%E9%94%99.PNG" class>
<p><strong>这里补充wordnet包安装方法：</strong><br>  (1) 命令行cmd打开，输入python；<br>(2) 继续输入<code>import nltk</code>和<code>nltk.download()</code>如下图所示：</p>
  <img src="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/wordnet%E4%B8%8B%E8%BD%BDcmd.PNG" class>
<p>(3) 可能会报错远程主机强制关闭了一个连接。<br>  解决办法：(1)连VPN (2)利用别人已经下载到本地的wordnet包,具体参照这篇博客。<a href="https://blog.csdn.net/Charchunchiu/article/details/96436736?depth_1-utm_source=distribute.pc_relevant.none-task&utm_source=distribute.pc_relevant.none-task" target="_blank" rel="noopener">Python NLTK WordNet的在线与手动安装方法</a><br>  (4) 正常情况下,弹出如下窗口，选择<code>Corpora/wordnet</code>下载即可。</p>
  <img src="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/wordnet%E4%B8%8B%E8%BD%BD%E7%95%8C%E9%9D%A2.PNG" class>
</li>
<li><p>设置停用词</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">from</span> wordcloud <span class="keyword">import</span> STOPWORDS<span class="comment">#导入原有的停用词包</span></span><br><span class="line">    additional_stopwords=[]</span><br><span class="line"><span class="keyword">with</span> open(stopwordsfile,<span class="string">'r'</span>,encoding=<span class="string">'UTF-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">      <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">          additional_stopwords.append(line.replace(<span class="string">"\n"</span>,<span class="string">""</span>))</span><br><span class="line">    stop_words = additional_stopwords + list(STOPWORDS)<span class="comment">#额外添加自己的停用词</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>应用wordcloud包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span><br><span class="line">wordcloud = WordCloud(stopwords=stop_words,background_color=<span class="string">'white'</span>,collocations=<span class="literal">True</span>,colormap=<span class="string">'viridis'</span>,width=<span class="number">2160</span>,height=<span class="number">1080</span>,max_words=<span class="number">50</span>,prefer_horizontal=<span class="number">1</span>).generate(mytext)</span><br><span class="line">plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>)</span><br><span class="line">plt.axis(<span class="string">"off"</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<img src="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/maas%E8%AF%8D%E4%BA%91%E7%BB%93%E6%9E%9C.PNG" class title="[词云展示]">

</li>
</ol>
<h2 id="LDA主题分类"><a href="#LDA主题分类" class="headerlink" title="LDA主题分类"></a>LDA主题分类</h2><p>这里使用<strong>sklearn</strong>的<strong>LDA</strong>包。<br>基于之前的<strong>文本预处理</strong>，还需要转换为<strong>词向量</strong>的形式，才可放入LDA模型训练。<br>具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer <span class="comment">#词向量转换模块</span></span><br><span class="line"><span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> LatentDirichletAllocation <span class="keyword">as</span> LDA</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> matplotlib.pyplot <span class="keyword">import</span> MultipleLocator</span><br><span class="line"></span><br><span class="line"><span class="comment">#Initialise the count vectorizer with the English stop words</span></span><br><span class="line">count_vectorizer = CountVectorizer(stop_words=stop_words)<span class="comment">#这里也可以设置停用词</span></span><br><span class="line"><span class="comment"># Fit and transform the processed titles</span></span><br><span class="line">count_data = count_vectorizer.fit_transform(mytext)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_topics</span><span class="params">(model, count_vectorizer, n_top_words)</span>:</span></span><br><span class="line">    words = count_vectorizer.get_feature_names()</span><br><span class="line">    <span class="keyword">for</span> topic_idx, topic <span class="keyword">in</span> enumerate(model.components_):</span><br><span class="line">        print(<span class="string">"\nTopic #%d:"</span> % topic_idx)</span><br><span class="line">        print(<span class="string">" "</span>.join([words[i]</span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> topic.argsort()[:-n_top_words - <span class="number">1</span>:<span class="number">-1</span>]]))</span><br><span class="line">n_topics = range(<span class="number">3</span>,<span class="number">7</span>,<span class="number">1</span>)</span><br><span class="line">perplexityLst = [<span class="number">1.0</span>]*len(n_topics)</span><br><span class="line"></span><br><span class="line"><span class="comment">#训练LDA并打印训练时间</span></span><br><span class="line">lda_models = []</span><br><span class="line"><span class="keyword">for</span> idx, n_topic <span class="keyword">in</span> enumerate(n_topics):</span><br><span class="line">    print(idx,n_topic)</span><br><span class="line">    lda = LDA(n_components=n_topic, max_iter=<span class="number">2000</span>,learning_method=<span class="string">'batch'</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">#                                    perp_tol=0.1, #default</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#                                    doc_topic_prior=1/n_topic, #default</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#                                    topic_word_prior=1/n_topic, #default</span></span><br><span class="line"></span><br><span class="line">                                    verbose=<span class="number">0</span>)</span><br><span class="line">    t0 = time.time()</span><br><span class="line">    lda.fit(count_data)</span><br><span class="line">    perplexityLst[idx] = lda.perplexity(count_data)</span><br><span class="line">    lda_models.append(lda)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"# of Topic: %d, "</span> % n_topics[idx])</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"done in %0.3fs, N_iter %d, "</span> % ((time.time() - t0), lda.n_iter_))</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"Perplexity Score %0.3f"</span> % perplexityLst[idx])</span><br><span class="line"></span><br><span class="line"><span class="comment">#打印最佳模型</span></span><br><span class="line">number_words=<span class="number">10</span></span><br><span class="line">best_index = perplexityLst.index(min(perplexityLst))</span><br><span class="line">best_n_topic = n_topics[best_index]</span><br><span class="line">best_model = lda_models[best_index]</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Best # of Topic: "</span>, best_n_topic)</span><br><span class="line">print_topics(best_model, count_vectorizer, number_words)</span><br><span class="line"></span><br><span class="line"><span class="comment">#绘制不同主题数perplexity的不同</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">xaxis=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(n_topics)):</span><br><span class="line">    xaxis.append(n_topics[i])</span><br><span class="line">ax.plot(xaxis, perplexityLst)</span><br><span class="line">x_major_locator=MultipleLocator(<span class="number">1</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">"number of topics"</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">"Approximate Perplexity"</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>最终我这里选择了分为3个主题。虽然2个的perplexity效果好一些，但我根据需要选择了3个。</p>
<img src="/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/perplexity%E6%8C%87%E6%95%B0.PNG" class title="[perplexity指数]">

<p>Topic #1: 城市系统角度<br>model city public business alliance actor efficiency factor system new<br>Topic #2: 各出行模式运营商角度<br>user time market adoption road potential intermediary car operator public<br>Topic #3: 用户出行模式选择角度<br>car public model mode bundle sharing new travel choice demand</p>
<p>好了，这次就到这里了。具体的参数设置还是参照官方文档。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/02/%E3%80%90%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Wordcloud%E8%AF%8D%E4%BA%91%E5%88%86%E6%9E%90+LDA%E4%B8%BB%E9%A2%98%E5%88%86%E7%B1%BB/" data-id="ckli4trcg0009ssyp6vs37nv3"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LDA/" rel="tag">LDA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NLP/" rel="tag">NLP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Wordcloud/" rel="tag">Wordcloud</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2020-2021
        Eva Ren
      </li>
      <li>
        
          Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>

        
        
        <ul class="list-inline">
<!--  <li>PV:<span id="busuanzi_value_page_pv"></span></li>-->
<!--  <li>UV:<span id="busuanzi_value_site_uv"></span></li>-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <li>本站总访问量 <span id="busuanzi_value_site_uv"></span>次</li>
  <li>本页面总访问量 <span id="busuanzi_value_page_pv"></span>次</li>
</ul>

<script>
  $(document).ready(function () {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var pvcountOffset = 0;  // 初始化首次数据
    var uvcountOffset = 0;

    function fixCount() {
      if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
        $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
        clearInterval(int);
      }
      if ($("#busuanzi_container_site_pv").css("display") != "none") {
        $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据
        clearInterval(int); // 停止检测
      }
    }
  });
</script>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
      </li>
      <li>
        
          <span id="sitetime">载入运行时间...</span>
          <script>
            function siteTime() {
              var seconds = 1000;
              var minutes = seconds * 60;
              var hours = minutes * 60;
              var days = hours * 24;
              var years = days * 365;
              var today = new Date();
              var startYear = "2020";
              var startMonth = "1";
              var startDate = "30";
              var startHour = "0";
              var startMinute = "0";
              var startSecond = "0";
              var todayYear = today.getFullYear();
              console.log(startYear);
              console.log(todayYear);
              var todayMonth = today.getMonth() + 1;
              var todayDate = today.getDate();
              var todayHour = today.getHours();
              var todayMinute = today.getMinutes();
              var todaySecond = today.getSeconds();
              var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
              var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
              var diff = t2 - t1;
              var diffYears = Math.floor(diff / years);
              var diffDays = Math.floor((diff / days) - diffYears * 365);
              var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
              var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                      minutes);
              var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                      diffMinutes * minutes) / seconds);
              if (startYear == todayYear) {
                document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                        " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
              } else {
                document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                        " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
              }
            }
            setInterval(siteTime, 1000);
          </script>
        
      </li>
    </ul>
  </div>

</footer>


    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
      <aside class="sidebar">
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/山.svg" alt="To the MOUNTAIN"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about/">联系我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script>
  var ayerConfig = {
    mathjax: false
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>




<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  </div>
</body>

</html>